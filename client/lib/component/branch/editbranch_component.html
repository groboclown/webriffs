<!-- TODO merge the branch playback and the branch edit -->

<div>
<a ng-href="#/film/view/{{cmp.filmId}}" ng-if="cmp.loaded">Film Details</a>
<a ng-href="#/branch/changes/{{cmp.branchId}}" ng-if="cmp.branchId != null">Branch History</a>
</div>

<div ng-if="! cmp.canReadQuips && cmp.loaded">
You do not have permissions to view the contents of this branch.
<div class="bug">BUG this message may be incorrectly shown while the page is loading.</div>
</div>

<div ng-if="cmp.canReadQuips" class="component">
    
    <div ng-if="cmp.loaded">
        <div><span>{{cmp.filmName}}</span> <span>({{cmp.filmReleaseYear}})</span>
            <span ng-if="cmp.urlChangeId &gt;= 0">(revision {{cmp.changeId}})</span>
            <span ng-if="cmp.urlChangeId &lt; 0">(pending changes)</span>
        </div>
        <div>{{cmp.branchName}}</div>
        <div>{{cmp.description}}</div>
        <div>Last updated on {{cmp.updatedOn}}</div>
    </div>
    <div ng-if="! cmp.loaded">
        <span ng-if="cmp.loadError">Problem loading branch.  You may not have
        permission to see it, or it may not exist.</span>
        <span ng-if="! cmp.loadError">loading...</span>
    </div>

    <branch-updates current-branch="cmp.branchDetails"></branch-updates>
    
    <div ng-if="cmp.hasPendingChange">
        You have changes saved on the server that haven't been committed
        to the branch.
        <button ng-click="cmp.commitChanges()">Commit Changes</button>
        <span ng-click="cmp.abandonChanges()">Abandon Changes</span>
    </div>
    
    <media-controller
        time="cmp.videoTimeProvider"
        controller="cmp.mediaAlertController"
        branch-details="cmp.branchDetails"></media-controller>
    
    <!-- quips flashing to the screen -->
    <div>
        <!-- FIXME set the style based on the edit state -->
        <div ng-repeat="quip in cmp.shownQuips" class="popup_quip">
            <div>
                <span ng-if="cmp.isEditable"
                    ng-click="cmp.editQuip(quip)">&#9998;</span>
                <span>{{quip.timestamp}}</span>
                <span ng-repeat="tag in quip.tags">
                    {{tag.name}}
                </span>
            </div>
            <div>{{quip.text}}</div>
        </div>
    </div>
    
    
    <!-- Edit the quip -->
    <div ng-if="cmp.canEditQuips">
        Edit quip:
<div class="bug">BUG this should not directly edit the time and text in the quip; they should be pushed to the object on save.</div>
        <form onsubmit="return false;">
        <div>
            <label for="quip_time">When </label>
            <input id="quip_time" type="text" ng-model="cmp.quipTime">
            <button ng-click="cmp.setPendingQuipTime()">Set from player</button>
        </div>
        <div>
            <label for="quip_text">With </label>
            <input id="quip_text" type="text" ng-model="cmp.quipText">
        </div>
        <div>
            <input type="submit" ng-click="cmp.savePendingQuip()" value="Save"
                ng-disabled="cmp.hasQuipTimeFormatError">
        </div>
        </form>
    </div>
    
    <div>
        <!-- filter controls -->
    </div>
    <table>
        <thead>
            <tr>
                <th ng-if="cmp.isEditable">&nbsp;</th>
                <th>Time</th>
                <th>Text</th>
                <th>Tags</th>
            </tr>
        </thead>
        <tbody ng-if="cmp.quipPaging.loading">
            <tr>
                <td colspan="3">loading {{cmp.quipPaging.percentLoaded}}%...</td>
            </tr>
        </tbody>
        <tbody ng-if="cmp.quipPaging.loadedError">
            <tr>
                <td colspan="3">Error loading the quips ({{cmp.quipPaging.error}})</td>
            </tr>
        </tbody>
        <tbody ng-if="cmp.quipPaging.loadedSuccessful">
            <!-- FIXME set the style based on the edit state -->
            <tr ng-repeat="quip in cmp.quipPaging.quips">
                <td ng-if="cmp.isEditable">
                    <!-- FIXME make this state based on the actual state -->
                    <!-- FIXME make the icons consistent across the site; this
                    differs with the meaning in the piece_edit_component.html -->
                    <span ng-click="cmp.editQuip(quip)">&#9998;</span>
                    <span ng-click="cmp.deleteQuip(quip)">&#10005;</span>
                    <span ng-click="cmp.revertQuip(quip)">&#9852;</span>
                </td>
                <td>{{cmp.getQuipTime(quip)}}</td>
                <td>{{quip.text}}</td>
                <td>
                    <span ng-repeat="tag in quip.tags">
                        {{tag.name}}
                    </span>
                </td>
            </tr>
        </tbody>
    </table>
</div>
