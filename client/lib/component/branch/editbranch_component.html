<!-- TODO merge the branch playback and the branch edit -->

<div>
<a ng-href="#/film/view/{{filmId}}" ng-if="loaded">Film Details</a>
<a ng-href="#/branch/changes/{{branchId}}" ng-if="branchId != null">Branch History</a>
</div>

<div ng-if="! canReadQuips && loaded">
You do not have permissions to view the contents of this branch.
<div class="bug">BUG this message may be incorrectly shown while the page is loading.</div>
</div>

<div ng-if="canReadQuips" class="component">
    
    <div ng-if="loaded">
        <div><span>{{filmName}}</span> <span>({{filmReleaseYear}})</span>
            <span ng-if="urlChangeId &gt;= 0">(revision {{changeId}})</span>
            <span ng-if="urlChangeId &lt; 0">(pending changes)</span>
        </div>
        <div>{{branchName}}</div>
        <div>{{description}}</div>
        <div>Last updated on {{updatedOn}}</div>
    </div>
    <div ng-if="! loaded">
        <span ng-if="loadError">Problem loading branch.  You may not have
        permission to see it, or it may not exist.</span>
        <span ng-if="! loadError">loading...</span>
    </div>

    <branch-updates current-branch="branchDetails"></branch-updates>
    
    <div ng-if="hasPendingChange">
        You have changes saved on the server that haven't been committed
        to the branch.
        <button ng-click="commitChanges()">Commit Changes</button>
        <span ng-click="abandonChanges()">Abandon Changes</span>
    </div>
    
    <media-controller
        time="videoTimeProvider"
        controller="mediaAlertController"
        branch-details="branchDetails"></media-controller>
    
    <!-- quips flashing to the screen -->
    <div>
        <!-- FIXME set the style based on the edit state -->
        <div ng-repeat="quip in shownQuips" class="popup_quip">
            <div>
                <span ng-if="isEditable"
                    ng-click="editQuip(quip)">&#9998;</span>
                <span>{{quip.timestamp}}</span>
                <span ng-repeat="tag in quip.tags">
                    {{tag.name}}
                </span>
            </div>
            <div>{{quip.text}}</div>
        </div>
    </div>
    
    
    <!-- Edit the quip -->
    <div ng-if="canEditQuips">
        <div ng-if="speechEntry" style="border:2px solid black; background: #f80;">
            <div ng-if="speechCapturing">
                <div>
                Speak the quip for {{quipTime}}
                <span ng-click="stopSpeechListen()">[ Stop voice entry ]</span>
                </div>
                
                <div>
                    <span ng-repeat="res in spoken">
                    {{res.best}}
                    </span>
                </div>
                
                <div>
                    <button ng-click="saveVoiceCapture()">Save</button>
                    <span ng-click="cancelVoiceCapture()">[ Cancel ]</span>
                </div>
            </div>
            <div ng-if="! speechCapturing">
                <span ng-click="stopSpeechListen()">[ Stop voice entry ]</span>
                <button ng-click="startVoiceCapture()">Start</button>
            </div>
        </div>
        <div ng-if="! speechEntry">
        Edit quip:
<div class="bug">BUG this should not directly edit the time and text in the quip; they should be pushed to the object on save.</div>
        <button ng-if="hasSpeechSupport"
            ng-click="startSpeechListen()">&#127908; Use your voice</button>
        <form onsubmit="return false;">
        <div>
            <label for="quip_time">When </label>
            <input id="quip_time" type="text" ng-model="quipTime">
        </div>
        <div>
            <label for="quip_text">With </label>
            <input id="quip_text" type="text" ng-model="quipText">
        </div>
        <div style="font-size:3em;">
            <button ng-click="setPendingQuipTime()">Set time to now</button>
            <input type="submit" ng-click="savePendingQuip()" value="Save"
                ng-disabled="hasQuipTimeFormatError">
        </div>
        </form>
        </div>
    
    
    </div>
    
    <div>
        <!-- filter controls -->
    </div>
    <table>
        <thead>
            <tr>
                <th ng-if="isEditable">&nbsp;</th>
                <th>Time</th>
                <th>Text</th>
                <th>Tags</th>
            </tr>
        </thead>
        <tbody ng-if="quipPaging.loading">
            <tr>
                <td colspan="3">loading {{quipPaging.percentLoaded}}%...</td>
            </tr>
        </tbody>
        <tbody ng-if="quipPaging.loadedError">
            <tr>
                <td colspan="3">Error loading the quips ({{quipPaging.error}})</td>
            </tr>
        </tbody>
        <tbody ng-if="quipPaging.loadedSuccessful">
            <!-- FIXME set the style based on the edit state -->
            <tr ng-repeat="quip in quipPaging.quips">
                <td ng-if="isEditable">
                    <!-- FIXME make this state based on the actual state -->
                    <!-- FIXME make the icons consistent across the site; this
                    differs with the meaning in the piece_edit_component.html -->
                    <span ng-click="editQuip(quip)">&#9998;</span>
                    <span ng-click="deleteQuip(quip)">&#10005;</span>
                    <span ng-click="revertQuip(quip)">&#9852;</span>
                </td>
                <td>{{getQuipTime(quip)}}</td>
                <td>{{quip.text}}</td>
                <td>
                    <span ng-repeat="tag in quip.tags">
                        {{tag.name}}
                    </span>
                </td>
            </tr>
        </tbody>
    </table>
</div>
