<div ng-if="! cmp.loaded">
loading...
</div>
<div ng-if="cmp.loaded">
  <div ng-if="cmp.youtubeLoading">loading Youtube...</div>
  <div ng-if="! cmp.youtubeLoading"> should have loaded </div>
  <script>//<!--
// REFERENCE:
// https://developers.google.com/youtube/iframe_api_reference#Loading_a_Video_Player
var youtube = {
    // The YouTube player object.
    player: null,

    // List of functions that will be called when the video player is ready.
    onPlayerReady: [],

    // List of functions that will be called when the player's state changes.
    onPlayerStateChange: [],
    
    // List of functions that will be called when the player encounters an error
    // Argument:
    // 2 - The request contains an invalid parameter value. For example, this error occurs if you specify a video ID that does not have 11 characters, or if the video ID contains invalid characters, such as exclamation points or asterisks.
    // 5 - The requested content cannot be played in an HTML5 player or another error related to the HTML5 player has occurred.
    // 100 - The video requested was not found. This error occurs when a video has been removed (for any reason) or has been marked as private.
    // 101 - The owner of the requested video does not allow it to be played in embedded players.
    onError: [],

    lastPlayerState: null,
    
    // -2: not loaded
    // -1: unstarted
    // 0: ended
    // 1: playing
    // 2: paused
    // 3: buffering
    // 4: video cued
    getPlayerState: function() {
        if (youtube.player == null) {
            return -2;
        }
        return youtube.player.getPlayerState();
    },
    
    /**
     * Current time in seconds since the video started playing (float)
     */
    getPlaybackSeconds: function() {
        if (youtube.player == null) {
            return 0.0;
        }
        return youtube.player.getCurrentTime();
    },
    
    getDuration: function() {
        if (youtube.player == null) {
            return -1.0;
        }
        return youtube.player.getDuration();
    },
    
    stop: function() {
        youtube.player.stopVideo();
    },
    
    pause: function() {
        youtube.player.pauseVideo();
    },
    
    play: function() {
        youtube.player.playVideo();
    },
    
    seekTo: function(seconds) {
        youtube.player.seekTo(seconds, true);
    },
    
    getBufferedFraction: function() {
        return youtube.player.getVideoLoadedFraction();
    },
    
    videoId: null,
    
    setVideoId: function(id) {
        console.log("set the video id: " + id);
        youtube.videoId = id;
        if (youtube.isLoaded) {
            if (youtube.isReady) {
                youtube.player.loadVideoById(id);
            } else {
                // Rerun the ready listener, this time
                // we have a videoId, so it will create the
                // object.
                console.log("video id = " + id + "; the player is loaded, but not ready.  Should not happen!");
                onYouTubeIframeAPIReady();
            }
        } else if (! youtube._initialized) {
            youtube._initialized = true;
            youtube._tag = document.createElement('script');
            youtube._tag.src = "https://www.youtube.com/iframe_api";
            youtube._firstScriptTag = document.getElementsByTagName('script')[0];
            youtube._firstScriptTag.parentNode.insertBefore(
                    youtube._tag, youtube._firstScriptTag);
        } else {
            console.log("video id = " + id + "; the player is not loaded but is initialized; the video id was probably set too quickly.  Ignoring.");
        }
    },
    
    isReady: false,
    isLoaded: false,
    
    // private initialization stuff.
    _initialized: false,
    _tag: null,
    _firstScriptTag: null,
    _onReady: function(event) {
        youtube.isReady = true;
        for (var i = 0; i < youtube.onPlayerReady.length; ++i) {
            youtube.onPlayerReady[i](event);
        }
    },
    _onStateChange: function(event) {
        youtube.lastPlayerState = event.data;
        for (var i = 0; i < youtube.onPlayerStateChange.length; ++i) {
            youtube.onPlayerStateChange[i](event);
        }
    },
    _onError: function(event) {
        var errcode = event.data;
        if (errcode == 150) {
            errcode = 101;
        }
        for (var i = 0; i < youtube.onError.length; ++i) {
            youtube.onError[i](event);
        }
    }
};
media_config = youtube;


function onYouTubeIframeAPIReady() {
    youtube.isLoaded = true;
    if (youtube.videoId != null) {
        console.log("Creating the iframe player");
        
        var obj = document.getElementById("media_container");
        if (obj === null) {
            throw new Exception("No such element media_container");
        }
        
        
        var arg = {
            height: '390',
            width: '640',
            playerVars: { 'autoplay': 0 },
            videoId: youtube.videoId,
            events: {
                'onReady': youtube._onReady,
                'onStateChange': youtube._onStateChange,
                //'onPlaybackQualityChange': null,
                //'onPlaybackRateChange'
                //'onApiChange'
                'onError': youtube._onError
            }
        };
        youtube.player = YT.Player('#media_container', arg);
    } else {
        console.log("Delaying the iframe player creation until we have a videoId");
    }
}

// --></script>
</div>
