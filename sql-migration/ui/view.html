<!DOCTYPE html>
<html>
<head>
    <link rel="stylesheet" href="view.css" />
    <link rel="stylesheet" href="joint-0.9.0.min.css" />
    <script src="joint-0.9.0.min.js"></script>
    <script src="joint.layout.DirectedGraph.min.js"></script>
    <script src="joint.shapes.devs.min.js"></script>
    <script lang="javascript">
/* Came from the "uml" plug-in */
joint.shapes.schema = {};

joint.shapes.schema.Table = joint.shapes.basic.Generic.extend({
    markup: [
        '<g class="rotatable">',
          '<g class="scalable">',
            '<rect class="schema-table-name-rect"/><rect class="schema-table-columns-rect"/>',
          '</g>',
          '<text class="schema-table-name-text"/>',
        '</g>'
    ].join(''),

    defaults: joint.util.deepSupplement({
        type: 'schema.Table',
        attrs: {
            rect: { width: 200 },

            '.schema-table-name-rect': { stroke: 'black', 'stroke-width': 2, fill: {
                type: 'linearGradient',
                stops: [
                    { offset: '0%', color: '#0044e7' },
                    { offset: '100%', color: '#0034b1' },
                ] } },
            '.schema-table-columns-rect': { stroke: 'black', 'stroke-width': 2, fill: '#edf5fb' },

            '.schema-table-name-text': {
                'ref': '.schema-table-name-rect', 'ref-y': .5, 'ref-x': .5, 'text-anchor': 'middle', 'y-alignment': 'middle', 'font-weight': 'bold',
                'fill': 'black', 'font-size': 12,
                'font-family': 'Candara, Calibri, Segoe, "Segoe UI", Optima, Arial, sans-serif'
            }
        },

        name: [],
        columns: []

    }, joint.shapes.basic.Generic.prototype.defaults),

    initialize: function() {
        _.bindAll(this, 'updateRectangles');

        this.on('change:name change:columns', function() {
            this.updateRectangles();
            this.trigger('schema-update');
        });
        this.updateRectangles();
        joint.shapes.basic.Generic.prototype.initialize.apply(this, arguments);
    },

    getTableName: function() {
        return this.get('name');
    },

    updateRectangles: function() {
        var attrs = this.get('attrs');
        
        // Set the attributes for the name
        // The name is 1 line long, so the height is hard-coded to
        // 40.
        attrs['.schema-table-name-text'].text = this.getTableName();
        attrs['.schema-table-name-rect'].height = 40; // hard coded height
        
        // update the columns
        var offsetY = 40;
        var that = this;
        for (c in this.getEmbeddedCells()) {
            cell.translate(2, offsetY);
            offsetY += cell.size.height;
        }
    }

});

joint.shapes.schema.TableView = joint.dia.ElementView.extend({

    initialize: function() {
        joint.dia.ElementView.prototype.initialize.apply(this, arguments);

        this.model.on('schema-update', _.bind(function() {
            this.update();
            this.resize();
        }, this));
    }
});


joint.shapes.schema.ForeignKey = joint.dia.Link.extend({
    defaults: {
        type: 'schema.ForeignKey',
        attrs: {
            '.marker-target': { d: 'M 20 0 L 0 10 L 20 20 z', fill: 'black', stroke: 'black' },
        }
    }
});




function importfile(graph, filename) {
    $.get(filename, function (dom) {
        var tables = {};
        var columns = {};
        var edges = [];
        var column_list = [];
        var everything = [];
        
        $(dom).find('cell').each(function() {
            var el;
            var $cel = $(this);
            //console.log("cell " + $cel.attr("kind") + ", " + $cel.attr("id"));
            if ($cel.attr("kind") == "table") {
                el = new joint.shapes.schema.Table({
                    name: $cel.attr("name")
                });
                everything[everything.length] = el;
                tables[String($cel.attr("id"))] = {
                    name: $cel.attr("name"),
                    node: el
                };
                //console.log("tables[] = " + tables[String($cel.attr("id"))].name);
            } else if ($cel.attr("kind") == "column") {
                el = new joint.shapes.schema.Column({
                    name: $cel.attr("name"),
                    vtype: $cel.attr("type")
                });
                //console.log("-parent "+$cel.attr("parent"));
                everything[everything.length] = el;
                var col = {
                    tableid: String($cel.attr("parent")),
                    name: $cel.attr("name"),
                    vtype: $cel.attr("type"),
                    auto: $cel.attr("autoIncrement"),
                    node: el
                };
                columns[String($cel.attr("id"))] = col;
                column_list[column_list.length] = col;
            } else if ($cel.attr("kind") == "edge") {
                edges.push({
                    source: String($cel.attr("source")),
                    target: String($cel.attr("target"))
                });
            }
        });
        
        var i;
        for (i = 0; i < column_list.length; ++i) {
            var c = column_list[i];
            //console.log("c.tableid = " + c.tableid);
            //console.log("tables[] = " + tables[c.tableid]);
            tables[c.tableid].node.embed(c.node);
        }
        for (i = 0; i < edges.length; ++i) {
            var e = edges[i];
            var el = new joint.shapes.schema.ForeignKey({
                source: { id: columns[e.source].node },
                target: { id: columns[e.target].node }
            });
            everything.push(el);
        }
        
        graph.addCells(everything);
    });
}

$(document).ready(function () {
    var graph = new joint.dia.Graph;
    var paper = new joint.dia.Paper({
        el: $('#graph'),
        width: 600,
        height: 200,
        model: graph,
        gridSize: 10
    });
    
    
    
    graph.on('change:position', function(cell) {
        if (!! cell.type && cell.type !== 'schema.Table') {
            // don't allow edges and columns to be moved
            cell.set('position', cell.previous('position'));
        }
    });
    
    
    // Hard-coded name.  see genGraphXml.py
    importfile(graph, 'schema.graph.xml');
    
    // layout the boxes
    joint.layout.DirectedGraph.layout(graph, { setLinkVerticies: false });
});
    </script>
</head>
<body>
<div id="graph">
</div>
</body>
</html>
