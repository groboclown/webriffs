Server Source
=============

The server-side is accessed via a RESTful API.  The `restful` directory
contains the front-end, user accessible API functionality.  All other
directories are the business logic layer between the public API and the
database layer.


Architecture
------------

The server is a standard layer of low-level database access, business logic
that controls the use of the database, and the public layer that constructs
the input from the user, and shapes the output.

 * **Database Access:** controlled through the code generated by the
    `sql-migration` tool, which runs on the `sql` directory.  The code
    is generated by running, from the `build` directory,
    `python build.py generate_dbo generate_sql`
 * **Business Logic:** located in all but the `restful` directory under
    `php/src`.  This handles the input validation, and how the conceptual
    ideas in the project translate into database objects and actions.
    Most of the logic should reside in the `php/src/WebRiffs` directory, which
    itself uses the other libraries.
 * **Public API:** located in `php/src/restful` is used by the Tonic library
    to represent all the user actions as RESTful services.  These are a really
    thin layer that handle user authentication, the collection of the user
    input values, calling out to the business logic, then shaping the output
    from those calls into a form digestable from the web service.

There is, and should be, some double validation of the input values in both
the Public API layer and the Business Logic - the more these values are checked,
the more we'll hopefully cover all the bases.  Eventually, this may be
simplified to be all in a common location.


RESTful API
-----------

The Public API is implemented through the
[PHP Tonic library](http://www.peej.co.uk/tonic/), which all goes
through the `php/web/dispatch.php` file.  These use URL parameters (in the case
of GET requests) or JSon data as input, and the responses are in JSon data.

Most non-GET requests require a
[Cross-Site Request Forgery](http://en.wikipedia.org/wiki/Cross-site_request_forgery)
Token.  These must be requested from the server for a user's session, and
associated with a specific action.  They are only valid for a short time.

