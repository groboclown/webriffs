# The pending (not-submitted) user quips along with the pending-version
# (committed) for the branch

# FIXME this will create duplicates - the committed changes should be omitted
# if they overlap the pending ones; however, this behavior may be desired,
# as it allows the query to see the pending + the original values!

view:
    viewName: V_QUIP_USER_ALL
    query: "
        SELECT
            qup.User_Id User_Id
            , qup.Gv_Branch_Id Gv_Branch_Id
            , qup.Gv_Change_Id Gv_Change_Id
            
            , qup.Gv_Item_Id Gv_Item_Id
            , qup.Gv_Item_Version_Id Gv_Item_Version_Id
            
            , 0 Committed
            
            , qup.Text_Value Text_Value
            
            , qup.Tag_1  Tag_1
            , qup.Tag_2  Tag_2
            , qup.Tag_3  Tag_3
            , qup.Tag_4  Tag_4
            , qup.Tag_5  Tag_5
            , qup.Tag_6  Tag_6
            , qup.Tag_7  Tag_7
            , qup.Tag_8  Tag_8
            , qup.Tag_9  Tag_9
            , qup.Tag_10 Tag_10
            , qup.Tag_11 Tag_11
            , qup.Tag_12 Tag_12
            , qvp.Tag_13 Tag_13
            , qup.Tag_14 Tag_14
            , qup.Tag_15 Tag_15
            , qup.Tag_16 Tag_16
            , qup.Tag_17 Tag_17
            , qup.Tag_18 Tag_18
            , qup.Tag_19 Tag_19
            , qup.Tag_20 Tag_20
            
            , qup.Timestamp_Millis Timestamp_Millis
            , qup.Updated_On Updated_On
        FROM V_QUIP_USER_PENDING qup
        
        UNION
        
        SELECT
            quv.User_Id User_Id
            , quv.Gv_Branch_Id Gv_Branch_Id
            , quv.Gv_Change_Id Gv_Change_Id
            
            , quv.Gv_Item_Id Gv_Item_Id
            , quv.Gv_Item_Version_Id Gv_Item_Version_Id
            
            , 1 Committed
            
            , quv.Text_Value Text_Value
            
            , quv.Tag_1  Tag_1
            , quv.Tag_2  Tag_2
            , quv.Tag_3  Tag_3
            , quv.Tag_4  Tag_4
            , quv.Tag_5  Tag_5
            , quv.Tag_6  Tag_6
            , quv.Tag_7  Tag_7
            , quv.Tag_8  Tag_8
            , quv.Tag_9  Tag_9
            , quv.Tag_10 Tag_10
            , quv.Tag_11 Tag_11
            , quv.Tag_12 Tag_12
            , qvv.Tag_13 Tag_13
            , quv.Tag_14 Tag_14
            , quv.Tag_15 Tag_15
            , quv.Tag_16 Tag_16
            , quv.Tag_17 Tag_17
            , quv.Tag_18 Tag_18
            , quv.Tag_19 Tag_19
            , quv.Tag_20 Tag_20
            
            , qup.Timestamp_Millis Timestamp_Millis
            , qup.Updated_On Updated_On
        FROM V_QUIP_USER_VERSION quv
        WHERE quv.Gv_Item_Id NOT IN 
        "
    columns:
        - column:
            name: User_Id
            type: int
            constraints:
                - constraint:
                    type: foreign key
                    table: USER
                    column: User_Id
        - column:
            name: Gv_Branch_Id
            type: int
            constraints:
                - constraint:
                    type: foreign key
                    table: GV_BRANCH
                    column: Gv_Branch_Id
        - column:
            name: Gv_Change_Id
            type: int
            constraints:
                - constraint:
                    type: foreign key
                    table: GV_CHANGE
                    column: Gv_Change_Id
        - column:
            name: Gv_Item_Id
            type: int
            constraints:
                - constraint:
                    type: foreign key
                    table: GV_ITEM
                    column: Gv_Item_Id
        - column:
            name: Gv_Item_Version_Id
            type: int
            constraints:
                - constraint:
                    type: foreign key
                    table: GV_ITEM_VERSION
                    column: Gv_Item_Version_Id
        - column:
            name: Text_Value
            type: nvarchar(2048)
            constraints:
                - constraint:
                    type: not null

        - column:
            name: Tag_1
            type: nvarchar(64)
        - column:
            name: Tag_2
            type: nvarchar(64)
        - column:
            name: Tag_3
            type: nvarchar(64)
        - column:
            name: Tag_4
            type: nvarchar(64)
        - column:
            name: Tag_5
            type: nvarchar(64)
        - column:
            name: Tag_6
            type: nvarchar(64)
        - column:
            name: Tag_7
            type: nvarchar(64)
        - column:
            name: Tag_8
            type: nvarchar(64)
        - column:
            name: Tag_9
            type: nvarchar(64)
        - column:
            name: Tag_10
            type: nvarchar(64)
        - column:
            name: Tag_11
            type: nvarchar(64)
        - column:
            name: Tag_12
            type: nvarchar(64)
        - column:
            name: Tag_13
            type: nvarchar(64)
        - column:
            name: Tag_14
            type: nvarchar(64)
        - column:
            name: Tag_15
            type: nvarchar(64)
        - column:
            name: Tag_16
            type: nvarchar(64)
        - column:
            name: Tag_17
            type: nvarchar(64)
        - column:
            name: Tag_18
            type: nvarchar(64)
        - column:
            name: Tag_19
            type: nvarchar(64)
        - column:
            name: Tag_20
            type: nvarchar(64)


        - column:
            name: Timestamp_Millis
            type: int
        - column:
            name: Updated_On
            type: timestamp
    constraints:
        - constraint:
            type: fake index
            columns: User_Id, Gv_Branch_Id